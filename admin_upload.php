<?php
include_once "prevent_direct_access.php";
require_once 'util_funcs.php';

if (!isset($_SESSION)) {
    session_start();
    $now = time();

    if (isset($_SESSION['discard_after']) && $now > $_SESSION['discard_after']) {
        session_unset();
        session_destroy();
        die("Session Timeout\nPlease refresh the page");
    }
} else {
    $_SESSION['discard_after'] = time() + 60;
}

if (!$_FILES) echo "No file uploaded";
elseif (isset($_SESSION['discard_after']) && $now < $_SESSION['discard_after']) {
    if (isset($_POST['admin_malware_name']) && $file = check_for_uploads('admin_uploaded_file')) {
        $malware_name = sanitizeString($_POST['admin_malware_name']);
        if ($vmn = validate_malware_name($malware_name)) die($vmn);
        $filename = sanitizeString($file['name']);
        $malware_content = file_get_contents($filename, NULL, NULL, NULL, 20);
        echo "Uploaded: $filename\nThe file is processing...\n";
        if ($malware_content && derive_signature($malware_name, $malware_content)) {
            echo "File process successfully\nMalware signature for $malware_name is recorded";
        } else die("FATAL ERROR\nUnable to process this file!!");
    };
} else die("Session Timeout\nPlease refresh the page");

function derive_signature($malw_name, $content)
{
    global $hn, $db, $un, $pw;
    if ($conn = get_connection($hn, $db, $un, $pw)) {
        if ($conn->connect_error) {
            session_unset();
            session_destroy();
            return false;
        }
        $query = "INSERT IGNORE INTO malwares(malw_name, signature) VALUE(?, ?)";
        $stmt = $conn->prepare($query);
        $stmt->bind_param('ss', $malw_name, $content);
        if ($stmt->execute()) {
            return true;
        } else {
            session_unset();
            session_destroy();
            return false;
        }
    }
    return false;
}


?>