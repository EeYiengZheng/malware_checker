<?php
include_once "prevent_direct_access.php";
include_once 'util_funcs.php';

if (!isset($_SESSION)) {
    session_start();
    $now = time();

    if (isset($_SESSION['discard_after']) && $now > $_SESSION['discard_after']) {
        session_unset();
        session_destroy();
        session_set_cookie_params(60);
        session_start();
    }
    $_SESSION['discard_after'] = $now + 60;
}

if (isset($_POST['uname'], $_POST['pword']) && $conn = get_connection($hn, $db, $un, $pw)) {
    $username = sanitizeMySQL($conn, $_POST['uname']);
    $password = sanitizeMySQL($conn, $_POST['pword']);
    if ($vp = validate_password($password) || $vu = validate_username($username)) die($vu . '\n' . $vp);
    $query = 'SELECT * FROM users WHERE username=?';
    $stmt = $conn->prepare($query);
    $stmt->bind_param('s', $username);
    $stmt->execute();
    $rs = $stmt->get_result();
    if ($rs->num_rows === 1 && $row = $rs->fetch_assoc()) {
        if ($row['admin']) {
            $password = $row['salt'] . $password;
            $password_hashed = strtolower(hash('sha256', $password));
            if ($password_hashed === $row['password']) {
                $_SESSION['authenticated'] = true;
                $_SESSION['username'] = $username;
                $html_respond =
                    '<div id="admin-info-div" class="info">'
                    . 'Hello, ' . $_SESSION["username"] . '<br>'
                    . 'Your session will end after ' . ($_SESSION['discard_after'] - time()) / 60 . ' minute of inactivity<br>'
                    . '<p>Upload a surely infected file</p> <br></div>'
                    . ' <form id="admin-upload-form" class="form" method="post" enctype="multipart/form-data" onsubmit="return validateUpload(this)" >
                            <input id="admin-upload-malware-name" type="text" name="malwarename" size="64" placeholder="Malware Name" accept="text/plain" required>
                            <label id="admin-upload-label" for="admin-upload-box" class="custom-upload"><i class="fa fa-cloud-upload"></i> Select a File</label>
                            <input id="admin-upload-box" class="upload-box" type="file" name="admin_upload">
                            <input id="admin-upload-submit" style="background-color: #ff727a;" class="btn admin-submitter" type="submit" value="Upload">
                        </form>
                        ';
            } else $html_respond = "";
        } else $html_respond = "";
    } else $html_respond = "";

    $stmt->close();
    $conn->close();
} else $html_respond = "";

echo $html_respond;


?>