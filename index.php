<?php
if (!isset($_SESSION)) {
    session_start();
    $now = time();

    if (isset($_SESSION['discard_after']) && $now > $_SESSION['discard_after']) {
        session_unset();
        session_destroy();
        session_set_cookie_params(60);
        session_start();
    }
    $_SESSION['discard_after'] = $now + 60;
}
// the HTML
// from here to ??
echo <<<html_dump_top

<!DOCTYPE html>
<html>
<head>
    <title>Malware Checker</title>
    <link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="//fonts.google.com/specimen/Open%20Sans?selection.family=Open%20Sans">
    <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
    <style>
        * {
            box-sizing: border-box
        }

        body, html {
            height: 100%;
            margin: 0;
            font-family: "Open Sans";
        } 

        button:hover {
            opacity: 0.9;
        }
        
        input {
            padding: 10px;
            margin: 3px;
            margin-bottom: 8px;
            width: 100%;
            font-size: 17px;
            border: 1px solid #aaa;
            border-radius: 5px;
        }
 
        input[type="file"] {
            display: none;
        }

        .tablink {
            background-color: #777;
            color: white;
            float: left;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 14px 16px;
            font-size: 1.25em;
        }

        .tablink:hover {
            background-color: #888;
        }

        .tabcontent {
            color: white;
            display: none;
            padding: 100px 20px;
            height: 100%;
            text-align: center;
        }
        
        .custom-upload {
            border: 1px solid #ccc;
            border-radius: 5px;
            margin-left: 3px;
            display: inline-block;
            padding: 6px 12px;
            cursor: pointer;
            width: 100%;
        }
        
        .form {
            color: black;
            background-color: #fff;
            margin: 50px auto;
            padding: 30px;
            width: 60%;
            min-width: 300px;
            border-radius: 10px;

        }
        
        .btn {
            color: #fff;
            border: none;
            padding: 10px 20px;
            font-size: 1.25em;
            cursor: pointer;
            border-radius: 5px;
        }

        .info {
            align-items: center;
        }
        
        #checker-tab {
            background-color: #5fccff;
        }
        
        #admin-tab {
            background-color: #ff727a;
        }
        
        footer {
            position: relative;
            width: 100%;
        }
    
        p.footer-text {
            position: absolute;
            width: 100%;
            color: #fff;
            font-size: 0.8em;
            text-align: center;
            bottom:0;
        }

    </style>
</head>
<body>

<button id="checker-btn" class="tablink" style="width: 75%;" onclick="openPage('checker-tab', this, '#5fccff')">
    Malware Checker
</button>
<button id="admin-btn" class="tablink" style="width: 25%;" onclick="openPage('admin-tab', this, '#ff727a')">
    Admin
</button>
html_dump_top;

// tabs
echo ' 
    <div id="checker-tab" class="tabcontent">
        <div id="user-info-div" class="info">
            <h1>Malware Checker</h1>
            <p>Malware Checker checks a file to determine if it could be a malware</p>
        </div>
        <form id="user-upload-form" class="form" method="post" action="" enctype="multipart/form-data">
            <label id="user-upload-label" for="user-upload-box" class="custom-upload"><i class="fa fa-cloud-upload"></i> Select a File</label>
            <input id="user-upload-box" class="upload-box" type="file" name="user_upload">
            <input id="user-upload-submit" style="background-color: #5fccff;" class="btn" type="submit" value="Upload">
        </form>
        <pre style="font-size: 1.25em;">
            <p id="user-status-message" style="color: white;"></p>
	    </pre>
    </div>
    
    <div id="admin-tab" class="tabcontent">
    ';
if (isset($_SESSION['authenticated']) && $_SESSION['authenticated'] === true) {
    echo "<h1>Administration</h1><br>";
    echo "<div id=\"admin-info-div\" class=\"info\">";
    echo "Hello, " . $_SESSION["username"] . "<br>";
    echo "Your session will end in: " . ($_SESSION['discard_after'] - time()) / 60 . ' minutes <br>';
    echo "<p>Upload a surely infected file</p> <br>
         </div>
        ";
    echo '
        <form id="admin-upload-form" class="form" method="post" enctype="multipart/form-data" onsubmit="return validateUpload(this)" >
            <input id="admin-upload-malware-name" type="text" name="malwarename" size="64" placeholder="Malware Name" accept="text/plain" required>
            <label id="admin-upload-label" for="admin-upload-box" class="custom-upload"><i class="fa fa-cloud-upload"></i> Select a File</label>
            <input id="admin-upload-box" class="upload-box" type="file" name="admin_upload">
            <input id="admin-upload-submit" style="background-color: #ff727a;" class="btn admin-submitter" type="submit" value="Upload">
        </form>
        <pre style="font-size: 1.25em;">
            <p id="admin-status-message" style="color: white;"></p>
        </pre>
        </div>
        ';
} else {
    echo '
    <h1>Administration</h1><br>
    <div id="admin-info-div" class="info">
        <p>Authenticate as an administrator to continue...</p>
    </div>
    <form id="admin-login-form" class="form" method="post" onsubmit="return validateLogin(this)" enctype="multipart/form-data">
        <input id="admin-uname" type="text" name="uname" size="32" placeholder="Username" accept="text/plain" required>
        <input id="admin-pword" type="password" name="pword" size="64" placeholder="Password" accept="text/plain" required>
        <input id="admin-login-submit" style="background-color: #ff727a;" class="btn" type="submit" value="Login">
    </form>
    <pre style="font-size: 1.25em;">
        <p id="admin-status-message" style="color: white;"></p>
    </pre>
    </div>
    ';
}

echo <<<html_dump_bottom

<footer id="static-footer">
    <p class="footer-text">Created by: Ee Yieng Zheng (eeyieng.zheng@sjsu.edu)<br>For SJSU CS 174 - Server-side Web Programming</p>
</footer>

<script>

    // user file upload form
    $(document).on("submit", "#user-upload-form", function(e) {
        console.log('user upload ajax triggered');
        e.preventDefault();
        var file_data = $("#user-upload-box").prop("files")[0];
        if (file_data) {
            var form_data = new FormData();
            form_data.append("user_uploaded_file", file_data);
            $("#user-status-message").text("Uploading...");
            $.ajax({
                url: "user_upload.php",
                cache: false,
                contentType: false,
                processData: false,
                data: form_data,
                method: 'POST',
                type: 'POST',
                success: function(e){
                    console.log("user-upload-form sent to server");
                    $("#user-status-message").text(e);
                }
            });
        }
    });
    
    
    var acctVal, nameVal = false; 
    
    // administrator login form AJAX submission
    $(document).ready(function(){
        $("#admin-login-form").on("submit", function(e){
            e.preventDefault();
            if (acctVal) {
                $("#admin-status-message").text("Authenticating...");
                $.ajax({
                    url: 'authenticate.php',
                    type: 'POST',
                    dataType: 'html',
                    data: $("#admin-login-form").serialize(),
                    success: function(respond) {
                        console.log("admin-login-form sent to server");
                        if ($.trim(respond)) {
                            $("#admin-btn").click();
                            $("#admin-info-div").html(respond);
                            $("#admin-login-form").fadeOut();
                            $("#admin-status-message").text("");
                        } else {
                            console.log("in else");
                            $("#admin-login-form").fadeIn();
                            $("#admin-status-message").text("Incorrect username and password combination!");
                        }
                    }
                });
            }
        });
    });
    
    // administrator file upload form AJAX submission
    $(document).on("submit", "#admin-upload-form", function(e) {
        e.preventDefault();
        var file_data = $("#admin-upload-box").prop("files")[0];
        var form_data = new FormData();
        form_data.append("admin_uploaded_file", file_data);
        form_data.append("admin_malware_name", $("#admin-upload-malware-name").val())
        if (nameVal) {
            $.ajax({
                url: "admin_upload.php",
                cache: false,
                contentType: false,
                processData: false,
                data: form_data,
                method: 'POST',
                type: 'POST',
                success: function(e){
                    console.log("admin-upload-form sent to server" + e);
                    $("#admin-status-message").text(e);
                }
            });
        }
    });
            
    function openPage(pageName, elmnt, color) {
        var i, tabcontent, tablinks;
        $(".tabcontent").hide();
        tablinks = document.getElementsByClassName("tablink");
        for (i = 0; i < tablinks.length; i++) {
            tablinks[i].style.backgroundColor = "";
        }
        $("#"+pageName).slideDown();
        elmnt.style.backgroundColor = color;
    }
    
    $(document).ready(function(){
        $(document).on("change", "#user-upload-box", function(e){
            $("#user-upload-label").text(e.target.files[0].name);
        });
        $(document).on("change", "#admin-upload-box", function(e){
            $("#admin-upload-label").text(e.target.files[0].name);
        });
        $(document).on("click", "#user-upload-box", function(e){
            $("#user-upload-label").html("<i class='fa fa-cloud-upload'></i> Select a File");
        });
        $(document).on("click", "#admin-upload-box", function(e){
            $("#admin-upload-label").html("<i class='fa fa-cloud-upload'></i> Select a File");
        });
    });
    function validateUpload(form) {
        fail = "";
        field = form.malwarename.value.trim();
        console.log(field);
        if (!field) fail += "No malware name provided.\\n";
	    if (field.length > 64) fail += "Name needs to be less than 64 characters.\\n";
	    if (/[^A-Z0-9]/i.test(field )) fail += "Only a-z A-Z 0-9 are allowed in malware name.\\n";
	    
	    if (!$("#admin-upload-box").val()) fail += "No file selected";
        if (!fail) {
            $("#admin-status-message").text("");
            nameVal = true;
            return true;
        }
        else {
            nameVal = false;
            $("#admin-status-message").text(fail);
            return false;
        }
    }
        
    function validateLogin(form) {
		fail = validateUsername(form.uname.value);
		fail += validatePassword(form.pword.value);
		
		if (fail === "") {
		    acctVal = true;
		    return true;
		}
		else {
		    acctVal = false;
            document.getElementById("admin-status-message").innerHTML = fail;
		    return false
		}
	}
	function validateUsername(field) {
	    if (field.trim() === "") return "No username provided.\\n";
	    if (field.trim().length > 32) return "Username need to be less than 32 characters.\\n";
	    if (/[^-\w]/.test(field.trim())) return "Only a-z A-Z 0-9 _ and - are allowed in username.\\n";
	    return ""
	}
	function validatePassword(field) {
	    if (!/.{8,64}/.test(field.trim())) return "Password need to be 8 characters and up to 64 characters.\\n";
	    if (/[^a-zA-Z0-9!@#\$%\^&\*_\-=\+`~]/.test(field.trim())) return "Password can only contain a-z A-Z 0-9 and ~`!@#$%^&*_-=+\\n";
	    return ""
	}
	
    $("#checker-btn").click();
	
	setInterval(function () {
        if (window.innerHeight >= 800) $("#static-footer").fadeIn();
        if (window.innerHeight < 800) $("#static-footer").fadeOut();
    }, 500);
    
</script>

</body>
</html>
html_dump_bottom;


?>
